# FCM Hosts Optimizer (v3.0)

é€šè¿‡ç¡¬é“¾æ¥ (Hard Link) ä¸åŸç”ŸæŒ‚è½½æŠ€æœ¯å®ç°çš„è‡ªé€‚åº” Systemless Hosts æ¨¡å—ã€‚å®Œç¾å…¼å®¹ Magisk, APatch ä¸ KernelSUã€‚

## âœ¨ æ ¸å¿ƒç‰¹æ€§

- **é«˜å…¼å®¹æ€§**: é‡‡ç”¨â€œç¡¬é“¾æ¥ + ç®¡ç†å™¨åŸç”ŸæŒ‚è½½â€æ–¹æ¡ˆï¼Œå½»åº•è§£å†³åœ¨é OverlayFS ç¯å¢ƒï¼ˆæˆ–å‘½åç©ºé—´éš”ç¦»ï¼‰ä¸‹çš„æŒ‚è½½å¤±æ•ˆé—®é¢˜ã€‚
- **åŠ¨æ€æ›´æ–°**: å³ä½¿ç”±ç®¡ç†å™¨æ‰˜ç®¡æŒ‚è½½ï¼Œå¾—ç›Šäº Inode å…±äº«æŠ€æœ¯ï¼ŒIP åŒæ­¥ä¾ç„¶å®æ—¶ç”Ÿæ•ˆï¼Œæ— éœ€é‡å¯ã€‚
- **åŒè¯­æ—¥å¿—**: `service.sh` ä¸ `fcm-update` å…¨é¢æ”¯æŒä¸­è‹±åŒè¯­æ—¥å¿—è¾“å‡ºï¼Œæ˜“äºæ’æŸ¥é—®é¢˜ã€‚
- **ä½èƒ½è€—è°ƒåº¦**: ç”± [MiceTimer](https://github.com/Mice-Tailor-Infra/micetimer) å¼•æ“ç»Ÿä¸€æ‰˜ç®¡ï¼Œæ”¯æŒ WakeLock åŸå­å†™å…¥ï¼Œç¡®ä¿åœ¨æ·±åº¦ç¡çœ ä¸‹ä¹Ÿèƒ½ç¨³å®šæ›´æ–°ã€‚
- **å®‰å…¨æ€§**: å¼ºåˆ¶ä¿ç•™ localhost å®šä¹‰ï¼Œè‡ªåŠ¨ç»´æŒ SELinux å®‰å…¨ä¸Šä¸‹æ–‡ã€‚

## ğŸ“¥ å®‰è£…ä¸è¿ç§»

1. ç¡®ä¿å·²å®‰è£…é…å¥—çš„ [MiceTimer](https://github.com/Mice-Tailor-Infra/micetimer) æ¨¡å—ã€‚
2. é€šè¿‡ Magisk / KernelSU / APatch å®‰è£…æœ¬æ¨¡å—å¹¶**é‡å¯**ã€‚
3. **è¿ç§»æç¤º**: è‹¥ä» v2.x å‡çº§ï¼Œå®‰è£…è„šæœ¬ä¼šè‡ªåŠ¨å¤„ç†æ—§ç‰ˆå†²çªï¼Œå»ºè®®å®‰è£…åæ£€æŸ¥ `/data/adb/fcm-hosts/service.log`ã€‚

## ğŸ›  å¸¸ç”¨å‘½ä»¤

```bash
# æ‰‹åŠ¨å¼ºåˆ¶æ›´æ–° FCM åº“
/system/bin/fcm-update
```

## âš™ï¸ é…ç½®è¯´æ˜

- **æ•°æ®åŒº**: `/data/adb/fcm-hosts/`
- **å®šæ—¶é…ç½®**: `/data/adb/timers.d/fcm-hosts.toml`
- **è¿œç¨‹æº**: `miceworld.top/fcm-hosts-next/fcm_dual.hosts`

## ğŸ“– æŠ€æœ¯åŸç† (Technical Principles)

### ç¡¬é“¾æ¥æŒ‚è½½ (Hard Link Mounting)
v3.0 æ ¸å¿ƒåœ¨äºå®‰è£…æ—¶æ‰§è¡Œ `ln -f /data/adb/fcm-hosts/hosts $MODPATH/system/etc/hosts`ï¼š
- **Inode å…±äº«**: ä¸¤ä¸ªè·¯å¾„æŒ‡å‘ç£ç›˜ä¸ŠåŒä¸€ä¸ªæ•°æ®å—ã€‚
- **æƒé™ç©¿é€**: æ™®é€š App é€šè¿‡è·¯å¾„å¯è§æ€§æ›´é«˜çš„ `/system` èº«ä»½è®¿é—®ï¼Œç»•è¿‡äº† `/data/adb` çš„æƒé™é™åˆ¶ã€‚
- **åŸç”Ÿæ²»ç†**: è®©ç®¡ç†å™¨åœ¨ Boot é˜¶æ®µå¤„ç†æŒ‚è½½ï¼Œæ¯” `service.sh` æ‰‹åŠ¨æŒ‚è½½æ›´é²æ£’ã€‚

### åŸå­åŸåœ°å†™å…¥ (In-place Write)
æ›´æ–°è„šæœ¬ä½¿ç”¨ `cat >` è¦†ç›–å†…å®¹è€Œé¿å… `mv` åŠ¨ä½œï¼Œä»è€Œä¿è¯æ–‡ä»¶ Inode ä¸å˜ï¼Œä½¿æ‰€æœ‰ç°æœ‰çš„æŒ‚è½½ç‚¹å†…å®¹åŒæ­¥æ›´æ–°ã€‚

## â¤ï¸ è‡´è°¢

- [FCM Hosts Project](https://miceworld.top/fcm-hosts-next/)
- [Topjohnwu (Magisk)](https://github.com/topjohnwu)
- [Tiann (KernelSU)](https://github.com/tiann)
