#!/system/bin/sh
# Mice FCM Hosts Updater - Atomic Engine

REMOTE_URL="https://miceworld.top/fcm-hosts-next/fcm_dual.hosts"
TARGET_FILE="/data/adb/fcm-hosts/hosts"
TMP_FILE="/data/adb/fcm-hosts/hosts.tmp"
UA="curl/7.80.0"

# 1. 缓存穿透下载 (带时间戳)
if ! curl -kfsSL -A "$UA" --connect-timeout 15 --retry 3 "${REMOTE_URL}?t=$(date +%s)" -o "$TMP_FILE.download"; then
    echo "[FCM] Download failed. / 下载失败。"
    exit 1
fi

# 2. 内容合法性校验
if ! grep -qi "google" "$TMP_FILE.download"; then
    echo "[FCM] Validation failed: Google IPs not found. / 校验失败：未找到有效 Google IP。"
    rm -f "$TMP_FILE.download"
    exit 1
fi

# 3. 重构 Hosts (物理隔离：强制保留 Localhost)
{
    echo "127.0.0.1 localhost"
    echo "::1 localhost ip6-localhost"
    echo "# --- Mjolnir FCM Verified ---"
    echo "# Sync Time: $(date '+%Y-%m-%d %H:%M:%S')"
    cat "$TMP_FILE.download"
} > "$TMP_FILE"

# 4. 安全对齐
chmod 644 "$TMP_FILE"
if [ -x "$(command -v chcon)" ]; then
    # 使用 reference 对齐或硬编码 fallback，确保更新后依然可读
    chcon --reference /system/bin/sh "$TMP_FILE" 2>/dev/null || chcon u:object_r:system_file:s0 "$TMP_FILE" 2>/dev/null || true
fi

# 5. 原地写入 (保持 Bind Mount 有效)
    # 不使用 mv，因为 mv 会改变 inode，导致挂载失效
    cat "$TMP_FILE" > "$TARGET_FILE"
    rm -f "$TMP_FILE"
    rm -f "$TMP_FILE.download"

echo "[FCM] Status: SUCCESS. System synced with EdgeOne. / 状态：同步成功。"